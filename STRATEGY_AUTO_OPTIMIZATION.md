# 策略自动优化系统

## 功能概述

训练完成或回测完成后，系统现在可以**自动修改和保存策略参数**。这消除了手动调整参数的繁琐过程，使系统能够根据回测结果动态优化策略。

## 核心功能

### 1. 自动参数推荐 (StrategyOptimizer.recommend_parameters)

基于回测结果自动计算最优参数：

```python
- 信号阈值 (signal_threshold)
  • 收益 > 15% → 提高到 0.6 (降低交易频率，提高胜率)
  • 收益 5%-15% → 保持 0.4 (平衡策略)
  • 收益 < 5% → 降低到 0.3 (增加交易信号)

- 持仓周期 (hold_days): 固定 7 天

- 止损 (stop_loss_pct): -2% (亏损 2% 时止损)

- 止盈 (take_profit_pct): +5% (盈利 5% 时止盈)
```

### 2. 自动参数应用 (StrategyOptimizer.apply_parameters)

推荐参数自动保存到配置文件：

**配置文件位置**: `~/.csgo_trading_config.json`

**保存内容**:
- 推荐的策略参数
- 最后更新时间
- 当前的性能指标

### 3. 参数流程

```
回测完成
    ↓
分析回测结果
    ↓
计算推荐参数
    ↓
自动保存到配置文件 ✅ 新增
    ↓
下次训练时可读取这些参数
    ↓
继续迭代优化
```

## 使用方法

### 1. 运行模型训练 (选项 2)

```bash
cd /Users/user/Downloads/csgoAuto
python3 kline_analyzer.py

# 选择 2 - 快速模型训练
```

**输出示例**:
```
【D】策略优化分析

【策略分析】
  累计收益: 5.60%
  胜率: 57.14%
  交易笔数: 7

【推荐参数调整】
  • 推荐信号阈值: 0.4 (当前: 0.5)
  • 推荐持仓周期: 7 天 (最小7天)
  • 建议止损: -2.0% (亏损2%时止损)
  • 建议止盈: +5.0% (盈利5%时止盈)

✅ 策略参数已自动应用并保存
   配置文件: /Users/user/.csgo_trading_config.json
   • 信号阈值: 0.4
   • 持仓周期: 7 天
   • 止损: -2.00%
   • 止盈: 5.00%
```

### 2. 查看当前策略配置 (选项 4)

```bash
python3 kline_analyzer.py

# 选择 4 - 查看当前策略配置
```

**输出示例**:
```
【当前策略配置】
================================================================================
📋 配置文件路径: /Users/user/.csgo_trading_config.json
⏰ 最后更新: 2025-10-23T16:56:16.773007

📊 策略参数:
   • 信号阈值: 0.4
   • 持仓周期: 7 天
   • 止损: -2.00%
   • 止盈: 5.00%

📈 上次训练的性能指标:
   • 累计收益: 5.60%
   • 胜率: 57.14%
   • 交易笔数: 7
```

## 配置文件结构

配置文件 `~/.csgo_trading_config.json` 的结构：

```json
{
  "strategy_params": {
    "signal_threshold": 0.4,
    "hold_days": 7,
    "stop_loss_pct": -0.02,
    "take_profit_pct": 0.05,
    "last_updated": "2025-10-23T16:56:16.773007",
    "performance_metrics": {
      "cumulative_return": 0.056,
      "win_rate": 0.5714285714285714,
      "total_trades": 7
    }
  }
}
```

## 参数优化逻辑

### 信号阈值自适应

| 回测收益 | 推荐阈值 | 说明 |
|---------|--------|------|
| > 15% | 0.6 | 高收益 → 提高质量要求，减少交易 |
| 5%-15% | 0.4 | 良好平衡 |
| < 5% | 0.3 | 低收益 → 降低要求，增加交易 |

### 止损和止盈规则

- **止损**: 固定 -2% (亏损 2% 时立即止损，保护本金)
- **止盈**: 固定 +5% (盈利 5% 时锁定收益，避免回吐)
- **持仓周期**: 固定 7 天 (平衡持仓时间)

## 迭代优化

每次训练都会：

1. ✅ 生成新的推荐参数
2. ✅ 自动保存到配置文件
3. ✅ 显示参数变化
4. ✅ 记录性能指标

### 示例迭代过程

```
第1次训练:
  回测收益: 2% → 推荐阈值: 0.3 (增加交易)
  
第2次训练:
  回测收益: 5.6% → 推荐阈值: 0.4 (保持平衡)
  
第3次训练:
  回测收益: 8% → 推荐阈值: 0.4 (继续优化)
  
...
```

## 关键改进

### 之前
- ❌ 只生成建议，不自动应用
- ❌ 需要手动修改参数
- ❌ 无法跟踪参数变化历史

### 现在
- ✅ **自动推荐和应用参数**
- ✅ 参数自动保存到配置文件
- ✅ 可查看完整的参数历史和性能指标
- ✅ 支持多次迭代自动优化

## 技术细节

### 主要类和方法

```python
class StrategyOptimizer:
    def analyze_performance(self):
        """分析回测性能"""
    
    def suggest_improvements(self, metrics):
        """建议改进方案"""
    
    def recommend_parameters(self):
        """推荐优化的参数"""
    
    def apply_parameters(self, params):
        """✅ 自动应用推荐参数"""

def load_current_strategy_config():
    """✅ 新增：加载并显示当前策略配置"""
```

### 集成点

在 `run_model_training_pipeline()` 中：

```python
# 获取推荐参数
recommended_params = optimizer.recommend_parameters()

# ✅ 自动应用参数
optimizer.apply_parameters(recommended_params)
```

## 未来扩展

1. **参数历史跟踪**: 记录所有参数变化历史
2. **对标分析**: 与历史最佳参数对比
3. **预测优化**: 使用机器学习预测最优参数
4. **约束条件**: 添加参数变化的约束（如最大变化率）
5. **A/B 测试**: 同时测试多组参数

## 常见问题

**Q: 如何重置参数到默认值？**
A: 删除 `~/.csgo_trading_config.json` 文件，然后运行一次训练即可。

**Q: 参数多久更新一次？**
A: 每次运行模型训练时都会根据最新的回测结果更新。

**Q: 可以手动修改配置文件吗？**
A: 可以，但建议让系统自动生成。手动修改可能导致参数不一致。

**Q: 如何禁用自动参数应用？**
A: 在源代码中注释掉 `optimizer.apply_parameters(recommended_params)` 这一行。
