# 🚀 新型工作流 - 三脚本分离模式

**工作流特点**:
- ✅ 分析脚本独立 (手动执行一次)
- ✅ 出售脚本独立 (手动执行一次)
- ✅ 后台守护进程 (长期自动运行)
- ✅ STEAM_ID 和 YOUPIN_PRIVATE_KEY 硬编码

---

## 🔧 配置信息

### 已硬编码的常量

```go
// 三个脚本都包含这些硬编码配置
const (
    STEAM_ID       = "76561199078507841"
    YOUPIN_APP_KEY = "12919014"
)
```

### 需要的环境变量

在运行 **seller** 脚本前，必须设置：

```bash
# 设置私钥环境变量
export YOUPIN_PRIVATE_KEY="$(cat private_key.pem)"

# 或者直接输入
export YOUPIN_PRIVATE_KEY="-----BEGIN RSA PRIVATE KEY-----
MIIEpAIBAAKCAQEA...
-----END RSA PRIVATE KEY-----"
```

---

## 📋 工作流说明

### 第一步：分析 (手动执行一次)

**脚本**: `./bin/analyzer`

**功能**:
- 连接数据库
- **从原始CSQAQ快照数据进行实时分析** (而不是查询预计算结果)
- 分析套利机会
- 生成求购订单
- 显示预计收益

**分析方法**:
- ✅ 加载所有商品的最新价格快照
- ✅ 对每个商品计算利润率
- ✅ 计算7天平均价格和价格趋势
- ✅ 基于波动率、订单量计算风险等级
- ✅ 生成综合评分 (0-100)
- ✅ 筛选出最好的20个机会

**命令**:
```bash
# 50元预算
./bin/analyzer -budget 50

# 100元预算
./bin/analyzer -budget 100

# 自定义预算
./bin/analyzer -budget 200
```

**输出示例**:
```
╔════════════════════════════════════════════════════════════════╗
║                  【分析脚本】- 套利分析 + 发布求购              ║
║ 预算: ¥50.00                                                  ║
╚════════════════════════════════════════════════════════════════╝

[步骤1] 🔌 连接数据库
✅ 数据库连接成功

[步骤2] 📊 套利分析
✅ 发现 20 个套利机会

📋 套利机会列表 (前10个):
 1 P250 | 污染物 (崭新出厂)          ¥18.70 ¥23.00 21.8% 低
 2 CZ75 | 螺形扭转 (略有磨损)         ¥12.10 ¥14.90 21.9% 低
 ... (更多)

💰 预算统计:
   • 总预算: ¥50.00
   • 已用: ¥49.50
   • 剩余: ¥0.50
   • 使用率: 99.0%

[步骤3] 🛒 生成求购订单
✅ 生成 2 个求购订单

📋 求购订单详情:
 1 P250 | 污染物 (崭新出厂)             2 ¥18.70 ¥37.40
 2 CZ75 | 螺形扭转 (略有磨损)          1 ¥12.10 ¥12.10

💸 总体收益预测:
   • 总投入: ¥49.50
   • 预计收入: ¥60.29
   • 预计利润: ¥10.79
   • 预计收益率: 21.8%

🚀 下一步:
   1. 在悠悠有品手动发布上述求购订单
   2. 等待卖家在Steam上出售给你 (通常1-24小时)
   3. 物品到账后，运行出售脚本: ./bin/seller
   4. 同时启动后台守护进程: ./bin/daemon
```

**操作步骤**:
1. 运行分析脚本
2. 根据输出结果，在悠悠有品手动发布求购订单
3. 等待物品到账

---

### 第二步：出售 (手动执行一次)

**脚本**: `./bin/seller`

**功能**:
- 读取Steam库存
- 找到目标物品
- 上架到悠悠有品
- 设置出售价格

**前置条件**:
```bash
# 必须先设置私钥环境变量
export YOUPIN_PRIVATE_KEY="$(cat private_key.pem)"
```

**命令**:
```bash
# 出售单个物品 (使用市场价)
./bin/seller -target "P250 | 污染物 (崭新出厂)"

# 指定出售价格
./bin/seller -target "P250 | 污染物 (崭新出厂)" -price 23.00

# 出售多个物品
./bin/seller -target "P250 | 污染物 (崭新出厂)" -qty 2 -price 23.00
```

**参数说明**:
```
-target "名称"    目标物品名称 (必需)
-price N          出售价格 (元,默认50)
-qty N            出售数量 (默认1)
```

**输出示例**:
```
╔════════════════════════════════════════════════════════════════╗
║                    【出售脚本】- 物品出售流程                  ║
║ 目标: P250 | 污染物 (崭新出厂)                                  ║
║ 数量: 2 件                                                     ║
╚════════════════════════════════════════════════════════════════╝

[步骤1] 📦 读取Steam库存
✅ 成功读取库存: 15 个物品

[步骤2] 🔍 查找目标物品: P250 | 污染物 (崭新出厂)
✅ 找到 2 件 "P250 | 污染物 (崭新出厂)"

[步骤3] 📤 上架物品到悠悠有品
✅ 成功上架 2 件物品

[步骤4] 💰 销售信息
✅ 物品已上架到悠悠有品

📊 销售详情:
   • 物品: P250 | 污染物 (崭新出厂)
   • 数量: 2 件
   • 出售价格: ¥23.00/件
   • 总收入: ¥46.00 (未计算手续费)

✅ 出售流程完成！

🚀 建议:
   • 同时启动后台守护进程监控止损/止盈: ./bin/daemon
   • 后台进程会自动执行策略调整和回测
```

**操作步骤**:
1. 设置 YOUPIN_PRIVATE_KEY 环境变量
2. 运行出售脚本，上架物品
3. 在悠悠有品上调整价格或等待买家购买

---

### 第三步：后台守护进程 (长期运行)

**脚本**: `./bin/daemon`

**功能**:
- 监控所有活跃持仓
- 自动检查止损/止盈条件
- 策略动态调整
- 定期回测分析

**特点**:
- ✅ 后台长期运行
- ✅ 如果不kill进程就一直运行
- ✅ 不消耗很多资源
- ✅ 定期输出检查结果

**命令**:
```bash
# 基本运行 (5分钟检查一次)
./bin/daemon

# 自定义检查间隔 (每2分钟检查一次)
./bin/daemon -interval 2m

# 自定义回测天数 (分析过去14天的数据)
./bin/daemon -days 14

# 禁用回测 (只检查止损/止盈)
./bin/daemon -backtest=false
```

**参数说明**:
```
-interval D       检查间隔时间 (默认5分钟)
-backtest bool    是否启用回测 (默认true)
-days N           回测天数 (默认7天)
```

**输出示例**:
```
╔════════════════════════════════════════════════════════════════╗
║           【后台守护进程】- 止损/止盈 + 策略调整 + 回测        ║
║ 检查间隔: 5m0s                                                ║
║ 回测模式: true                                                ║
╚════════════════════════════════════════════════════════════════╝

✅ 数据库连接成功
✅ 后台守护进程已启动 (PID: 12345)

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
[迭代 #1] ⏰ 2025-10-18 01:25:00
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

[模块1] 🛡️ 止损/止盈检查
   • 找到 3 个活跃持仓

   持仓 #1: P250 | 污染物
      • 买入价: ¥18.70
      • 当前价: ¥23.00
      • 利润率: 23.0%
      • 持仓天数: 2.5 天
      ✅ 达成止盈条件 (目标: 35%), 需要卖出

   持仓 #2: CZ75 | 螺形扭转
      • 买入价: ¥12.10
      • 当前价: ¥14.90
      • 利润率: 23.1%
      • 持仓天数: 2.5 天

   📊 本轮统计:
      • 需要止盈: 1 个
      • 需要止损: 0 个

[模块2] 🔧 策略调整
   • 分析最近 7 天的交易数据
   📊 统计数据:
      • 平均利润率: 22.3%
      • 总交易数: 142

   🔧 策略调整建议:
      • ✅ 利润率正常 (22.3%), 维持当前策略

[模块3] 📊 回测分析
   • 分析 7 天前 (2025-10-11) 的 100 笔交易

   📊 回测结果:
      • 平均利润率: 21.8%
      • 最高利润: 45.2%
      • 最低利润: -5.3%
      • 胜率: 92.0% (92/100)

   💡 回测分析:
      • ✅ 胜率很高 (92.0%), 策略有效

✅ 本轮检查完成，下次检查在 5m0s 后

(继续循环...)
```

**如何停止**:
```bash
# 按 Ctrl+C 停止进程
^C

# 或者从另一个终端杀死进程
pkill -f "bin/daemon"
```

---

## 📊 完整工作流示例

### 时间表

```
DAY 1 - 上午:
  10:00 - 运行分析脚本
         ./bin/analyzer -budget 50
         输出: 20个机会, 2个求购订单

DAY 1 - 下午:
  14:00 - 在悠悠有品手动发布2个求购订单

DAY 1 - 晚上:
  18:00 - 物品开始陆续到账

DAY 2 - 上午:
  09:00 - 物品全部到账后，运行出售脚本
         export YOUPIN_PRIVATE_KEY="$(cat private_key.pem)"
         ./bin/seller -target "P250 | 污染物" -price 23.00

  09:05 - 同时启动后台守护进程
         ./bin/daemon

DAY 2 - 下午:
  15:00 - 后台进程检查到止盈条件
         自动提醒需要卖出

DAY 3:
  - 后台进程持续运行
  - 每5分钟检查一次持仓
  - 自动输出策略调整建议
  - 每次迭代都运行回测分析

随时:
  - Ctrl+C 停止后台进程
  - 分析/出售脚本随时可手动运行
```

---

## 🎯 使用场景

### 场景1: 持续交易

```bash
# Day 1: 分析并发布求购
./bin/analyzer -budget 100

# Day 2: 物品到账后出售
export YOUPIN_PRIVATE_KEY="$(cat private_key.pem)"
./bin/seller -target "物品1" -price 100
./bin/seller -target "物品2" -price 150

# 启动后台守护进程(一直运行)
./bin/daemon

# 3天后继续分析新的机会
./bin/analyzer -budget 100

# (后台进程继续运行,无需重启)
```

### 场景2: 快速测试

```bash
# 小额测试
./bin/analyzer -budget 10

# 快速出售
./bin/seller -target "测试物品" -price 50 -qty 1

# 短期监控 (2分钟后自动停止)
timeout 2m ./bin/daemon -interval 30s
```

### 场景3: 大规模操作

```bash
# 大额预算分析
./bin/analyzer -budget 500

# 分批出售 (物品到账后)
for item in "物品1" "物品2" "物品3"; do
  ./bin/seller -target "$item" -price 100
done

# 启动守护进程持续监控
nohup ./bin/daemon -interval 3m > daemon.log 2>&1 &
```

---

## 🛡️ 错误处理

### 常见问题

| 问题 | 解决方案 |
|------|--------|
| 私钥环境变量未设置 | `export YOUPIN_PRIVATE_KEY=$(cat private_key.pem)` |
| 数据库连接失败 | 检查网络连接, ping 23.254.215.66 |
| 找不到物品 | 确保物品名称完全匹配, 物品已在库存中 |
| 后台进程如何停止 | Ctrl+C 或 pkill -f "bin/daemon" |

---

## 📋 总结

### 三脚本的职责

| 脚本 | 执行方式 | 频率 | 职责 |
|------|--------|------|------|
| analyzer | 手动运行 | 每天/每周一次 | 分析机会 + 生成订单 |
| seller | 手动运行 | 需要时运行 | 上架物品 + 设置价格 |
| daemon | 后台运行 | 持续运行 | 监控+止损+止盈+策略调整+回测 |

### 工作流特点

✅ **完全分离**: 三个脚本相互独立
✅ **灵活运行**: 可随时启动/停止
✅ **自动化**: 后台进程自动执行
✅ **可扩展**: 可轻松集成其他功能
✅ **易于调试**: 每个脚本独立输出日志

---

## 🚀 开始使用

```bash
# 第1步: 分析机会
./bin/analyzer -budget 50

# 第2步: 手动在悠悠有品发布求购
# (等待物品到账)

# 第3步: 出售物品
export YOUPIN_PRIVATE_KEY="$(cat private_key.pem)"
./bin/seller -target "物品名称" -price 100

# 第4步: 启动后台守护进程
./bin/daemon

# 完成! 后台进程会自动监控和调整
```

---

**准备好了? 现在就运行 `./bin/analyzer -budget 50` 开始吧!**
