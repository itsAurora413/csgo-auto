# 🏗️ 完整系统架构 - v1.4

**最后更新**: 2025-10-18 23:30 UTC
**系统版本**: trading-system-linux-x86_64.tar.gz (v1.4)

---

## 📊 系统三大核心模块

```
┌─────────────────────────────────────────────────────────────────┐
│                      CSGO 套利交易系统 v1.4                      │
└─────────────────────────────────────────────────────────────────┘
         ↓                    ↓                    ↓
    ┌────────┐          ┌────────┐          ┌────────┐
    │analyzer│          │ seller │          │daemon  │
    │ 分析器 │          │ 卖家   │          │ 监控器 │
    └────────┘          └────────┘          └────────┘
         ↓                    ↓                    ↓
  【发现机会】         【执行操作】         【验证策略】
    · 趋势分析         · 自动上架           · 回测分析
    · 评分排序         · 自动降价           · 趋势对比
    · 风险评估         · 自动下架           · 反馈建议
```

---

## 🔄 数据流转

```
【第1天】
   analyzer 运行
   ├─ 查询 YouPin 最新价格
   ├─ 分析 7 天价格趋势（buy+sell）
   ├─ 计算综合评分
   └─ 保存 arbitrage_opportunities（包含 price_trend）
        ↓
   【保存的数据】
   ├─ GoodName: "AK-47 | 龙王"
   ├─ CurrentBuyPrice: ¥186.50
   ├─ CurrentSellPrice: ¥228.00
   ├─ PriceTrend: "up" ← 新增字段
   ├─ RiskLevel: "low" ← 新增字段
   ├─ Score: 85.5
   └─ AnalysisTime: 2025-10-18 12:00:00

【第2-7天】
   重复上述过程，积累 7 天的历史数据

【第8天】
   daemon 回测模块启动
   ├─ 查询 7 天前生成的 500 条机会数据
   ├─ 按 price_trend 分类（up/down/stable）
   ├─ 计算各趋势的胜率和利润
   │  ├─ 向上: 胜率 85%, 平均利润 18%
   │  ├─ 向下: 胜率 45%, 平均利润 5%
   │  └─ 稳定: 胜率 70%, 平均利润 12%
   ├─ 对比分析
   └─ 输出策略反馈
        ↓
   【发现问题】
   "向下趋势胜率仅 45%，而向上趋势 85%"
   "表明 analyzer 对下跌趋势识别不够激进"
        ↓
   【生成建议】
   "建议修改 analyzer 的 down 趋势评分"
   "从 -6 分改为 -12 到 -15 分"
        ↓
   【人工应用】
   修改 analyzer 代码，重新编译
        ↓
   【下轮验证】
   下一个 8 天后，daemon 再次回测验证改进
```

---

## 🎯 analyzer (v1.3) - 发现机会

### 职责
```
✅ 分析每个商品的买价和售价趋势
✅ 同时看两个价格（买价60% + 售价40%）
✅ 预测7天后的价格变化
✅ 评估风险等级
✅ 生成综合评分（0-100）
✅ 输出详细日志
```

### 输入数据
```
YouPin 实时数据:
├─ YYYP_BUY_PRICE (求购价，我们的成本)
└─ YYYP_SELL_PRICE (售价，市场参考)

历史数据:
├─ 7天的价格快照
├─ 市场流动性（订单数）
└─ 交易量
```

### 核心算法
```
趋势分析 (四因子模型):
├─ 趋势因子 (40%): 线性回归斜率
├─ 季节性因子 (25%): 7天周期性
├─ 波动性因子 (20%): 标准差
└─ 均值回归因子 (15%): 偏离程度

综合评分 = max(
    买价评分 * 0.60 + 售价评分 * 0.40,  // 加权
    特殊处理: 两价都下跌时 = 极低评分
)

趋势判断:
├─ up: 综合评分 > 55 → 📈
├─ down: 综合评分 < 45 → 📉
└─ stable: 45-55 → →
```

### 输出结果
```
【物品】AK-47 | 龙王 (崭新出厂)
💰 求购价: ¥186.50 | 在售价: ¥228.00 | 利润率: 18.5%
📊 在售数: 156 | 求购数: 5 | 风险: low

📈 趋势: up - 价格趋势向上，市场看好，建议持续关注

🔮 7天后预测:
   • 7天平均求购价: ¥182.30 (当前: ¥186.50, 变化: 2.3%)
   • 7天平均在售价: ¥225.60 (当前: ¥228.00, 变化: 1.1%)

✅ 风险评估: low - 低风险，安全边际好
```

### 存储位置
```
二进制: dist/trading-system-linux/analyzer
代码: cmd/analyzer/main.go
文档: dist/TREND_ANALYSIS_LOGGING.md
```

---

## 💼 seller (v1.0) - 执行操作

### 职责
```
✅ 自动上架 YouPin 库存
✅ 自动调整价格（逐渐降低）
✅ 处理成交订单
✅ 管理账户余额
✅ 支持并发操作
```

### 工作流
```
1. 读取 purchase_plan（购买计划）
2. 按物品逐个上架到 YouPin
3. 设置初始价格
4. 每小时检查一次，如无人购买则逐渐降价
5. 订单成交时自动标记为已卖出
6. 记录实际交易利润
```

### 存储位置
```
二进制: dist/trading-system-linux/seller
代码: cmd/seller/main.go
文档: dist/docs/SELLING_API_README.md
```

---

## 📊 daemon (v1.4) - 验证策略 🆕

### 职责
```
✅ 分析 7 天前生成的所有机会数据
✅ 按价格趋势分类 (up/down/stable)
✅ 计算各趋势的胜率
✅ 对比趋势间的效能差异
✅ 识别 analyzer 的缺点
✅ 输出可实施的改进建议
✅ 提供反馈循环给 analyzer
```

### 工作流
```
启动 → 每5分钟执行一次 ←─┐
                          │
           回测模块        │
           ↓              │
  1. 查询 7 天前数据      │
  2. 按趋势分类          │
  3. 计算胜率和利润       │
  4. 对比分析            │
  5. 生成反馈            │
  6. 输出建议            │
           ↓              │
        等待 5 分钟 ──────┘
```

### 输出示例

#### 场景A：正常状态 ✅
```
向上: 胜率 85% | 向下: 胜率 80%
→ 🟢 【正常状态】
→ 建议: 维持当前 analyzer 策略
```

#### 场景B：问题识别 🔴
```
向上: 胜率 85% | 向下: 胜率 45%
→ 🔴 【严重问题】
→ 建议:
   1. 提高 down 趋势评分惩罚 (从 -6 改为 -12 到 -15)
   2. 当两个价格都下跌时，评分极低 (< 20)
   3. HIGH风险 + down趋势 = 自动过滤
   4. 市场中 >40% 是 down 趋势时，全局降分
```

### 存储位置
```
二进制: dist/trading-system-linux/daemon
代码: cmd/daemon/main.go
文档: dist/DAEMON_BACKTEST_ENHANCEMENT.md
```

---

## 🔀 三模块的关系

```
                    analyzer (持续运行)
                    生成新的opportunity
                         ↓
         ┌──────────────────────────┐
         │  数据库累积 7 天数据      │
         │  (500条记录/天)          │
         └──────────────────────────┘
                         ↓
        daemon 回测 (每天晚上运行)
        分析7天前的数据
                         ↓
         ┌──────────────────────────┐
         │  【反馈循环】            │
         │                          │
         │ 发现问题 → 提出建议      │
         │   ↓                      │
         │ 人工应用建议            │
         │   ↓                      │
         │ 修改 analyzer           │
         │   ↓                      │
         │ 重新编译部署            │
         │   ↓                      │
         │ 下一轮回测验证          │
         └──────────────────────────┘
                         ↓
         seller 继续执行交易
         独立操作，不受影响
```

---

## 📈 关键指标追踪

### analyzer 输出指标
```
每个机会记录:
├─ 综合评分 (0-100) → 用于排序
├─ PriceTrend (up/down/stable) → 用于分类
├─ RiskLevel (low/medium/high) → 用于风险控制
├─ ProfitRate (%) → 预期利润
└─ Confidence (%) → 预测可信度
```

### daemon 分析指标
```
按趋势统计:
├─ 交易数量
├─ 平均利润
├─ 最高/最低利润
├─ 胜率 (%)
├─ 盈利交易数
└─ 亏损交易数

对比指标:
├─ 向上 vs 向下 的胜率差异
├─ 向上 vs 向下 的平均利润差异
└─ 市场整体下跌百分比 (早期预警)
```

---

## 🚀 部署与运行

### 快速启动
```bash
# 1. 提取发行包
tar -xzf trading-system-linux-x86_64.tar.gz
cd trading-system-linux

# 2. 启动 analyzer（发现机会）
./analyzer -budget 100

# 3. 启动 seller（执行操作）
./seller

# 4. 启动 daemon（验证策略）- 后台运行
nohup ./daemon -interval 5m -days 7 > daemon.log 2>&1 &

# 5. 查看 daemon 输出
tail -f daemon.log
```

### 监控关键时刻
```
日期       模块        行动        目的
─────────────────────────────────────────────
周一-周六  analyzer   运行4次/天  不断发现新机会
周二-周日  seller     连续运行    执行交易

每晚22:00 daemon      运行回测    分析 7 天前数据
          (自动)       并输出建议  发现策略问题
```

---

## 💡 优化循环

```
【第0周】
初始部署，analyzer 开始生成数据

【第1周】
daemon 首次有足够数据（7天）
├─ 输出第一份回测报告
├─ 识别初步问题
└─ 提出第一轮改进建议

【第2周】
根据建议改进 analyzer
├─ 重新编译
├─ 部署新版本
└─ 开始新一轮数据收集

【第3周】
daemon 分析改进效果
├─ 对比第1周和第2周的数据
├─ 确认改进是否有效
└─ 继续优化或调整方向

【第4周+】
持续优化循环
├─ 每周一次回测
├─ 每周一个小改进
└─ 长期提升系统效能
```

---

## 📊 预期效果

### analyzer 改进目标
```
目标: 向上和向下趋势的胜率差异 < 10%

改进前: 85% - 45% = 40% (很大的差异)
改进后: 82% - 75% = 7% (正常范围)
```

### seller 改进目标
```
目标: 实际交易利润 接近 预期利润 ±5%

现在: ±15% (还有改进空间)
目标: ±5% (精准度提高)
```

### daemon 目标
```
✅ 每周生成一份清晰的反馈报告
✅ 自动识别 analyzer 的缺点
✅ 提供可实施的改进建议
✅ 驱动持续的系统优化
```

---

## 📁 文件清单

### 可执行文件
```
dist/trading-system-linux/
├─ analyzer (11M) - 趋势分析引擎
├─ seller (9M) - 自动交易执行
├─ daemon (11M) - 回测监控器
└─ run.sh - 一键启动脚本
```

### 文档
```
dist/
├─ DAEMON_BACKTEST_ENHANCEMENT.md ← daemon 详细说明
├─ TREND_ANALYSIS_LOGGING.md ← analyzer 详细说明
├─ COMPLETE_SYSTEM_ARCHITECTURE.md ← 本文件
├─ NEW_WORKFLOW.md ← 工作流说明
└─ START_HERE.md ← 快速开始
```

---

## ✅ 系统健康检查

### 部署前验证
```
□ analyzer 能正常运行 (生成机会)
□ seller 能正常运行 (执行交易)
□ daemon 能正常运行 (回测分析)
□ 数据库连接正常
□ 至少有 7 天历史数据
□ price_trend 字段存在于数据库
```

### 运行中监控
```
□ analyzer 每天生成 >100 个机会
□ seller 能成功上架商品
□ daemon 每5分钟执行一次
□ daemon 日志显示正确的胜率对比
□ 无数据库错误或超时
```

---

## 🎓 学习路径

1. **快速了解**: 阅读本文件 (10分钟)
2. **详细 analyzer**: 阅读 TREND_ANALYSIS_LOGGING.md (15分钟)
3. **详细 daemon**: 阅读 DAEMON_BACKTEST_ENHANCEMENT.md (15分钟)
4. **实际操作**: 部署系统 (30分钟)
5. **监控运行**: 观察第一周的数据 (持续)
6. **实施改进**: 根据 daemon 建议优化 (按需)

---

## 🔗 相关文件链接

- 📘 [analyzer 详细说明](TREND_ANALYSIS_LOGGING.md)
- 📘 [daemon 详细说明](DAEMON_BACKTEST_ENHANCEMENT.md)
- 📘 [工作流说明](NEW_WORKFLOW.md)
- 📘 [快速开始](START_HERE.md)
- 📘 [seller 说明](docs/SELLING_API_README.md)

---

**系统版本**: v1.4 (2025-10-18)
**最后更新**: 2025-10-18 23:30 UTC
**状态**: ✅ 完全实现

这是一个完整的、自优化的 CSGO 套利交易系统！
