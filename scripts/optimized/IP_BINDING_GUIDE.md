# IP绑定模式使用说明

## 新的工作逻辑

根据CSQAQ API的实际工作方式，脚本现在实现了正确的IP绑定逻辑：

### 🔄 工作流程

1. **启动时绑定IP**: 程序启动后立即调用 `POST /api/v1/sys/bind_local_ip` 绑定本地IP
2. **定期重新绑定**: 每35秒重新绑定一次IP（避免30秒限流）
3. **快速请求**: IP绑定成功后，可以每秒请求一次API
4. **自动降级**: 如果IP绑定失败，自动切换到30秒间隔模式

### 📊 性能对比

| 模式 | IP绑定 | 请求间隔 | 预估完成时间 |
|------|--------|----------|--------------|
| **绑定IP模式** | ✅ 启用 | 1秒/次 | ~3.3小时 |
| **未绑定模式** | ❌ 禁用 | 30秒/次 | ~100小时 |

### 🚀 使用方法

#### 1. 默认模式（推荐）
```bash
# 启用IP绑定，自动每35秒重新绑定
./bulk_fetch_goods_optimized-linux-amd64
```

#### 2. 显式启用IP绑定
```bash
# 明确启用IP绑定模式
./bulk_fetch_goods_optimized-linux-amd64 -binding
```

#### 3. 禁用IP绑定
```bash
# 禁用IP绑定，使用30秒间隔
./bulk_fetch_goods_optimized-linux-amd64 -no-binding
```

#### 4. 自定义请求间隔
```bash
# 自定义绑定IP后的请求间隔（毫秒）
./bulk_fetch_goods_optimized-linux-amd64 1500  # 1.5秒间隔
```

### 📝 日志输出示例

#### 启动日志
```
2024/10/11 11:30:00 开始获取饰品数据: ID 0 到 24041
2024/10/11 11:30:00 IP绑定配置: 启用
2024/10/11 11:30:00 绑定模式 - IP绑定间隔: 35s, 请求间隔: 1s
2024/10/11 11:30:00 ✅ 成功绑定本地IP到CSQAQ API
```

#### 运行过程日志
```
2024/10/11 11:30:01 开始处理范围: 0 - 24041 (24042 个商品)
2024/10/11 11:30:02 ✓ 保存 good_id 12021 (AK-47 | Redline), 价格: YYYP=25.50, Buff=24.80
2024/10/11 11:30:03 API限流等待 800ms (good_id 12022, 模式: 绑定IP)
2024/10/11 11:30:35 🔗 IP绑定状态: 已绑定, 下次重绑: 34s
2024/10/11 11:31:10 ✅ 成功绑定本地IP到CSQAQ API
```

#### 错误处理日志
```
2024/10/11 11:30:00 ⚠️ IP绑定被限流（最近已绑定）
2024/10/11 11:30:00 ⚠️ IP绑定失败，继续使用未绑定模式: IP绑定失败
2024/10/11 11:30:01 API限流等待 29s (good_id 12021, 模式: 未绑定IP)
```

### 🔧 技术实现

#### IP绑定API
```go
// 绑定IP的API端点
POST https://api.csqaq.com/api/v1/sys/bind_local_ip
Headers:
  ApiToken: WPXHV1H7O5Y8N8W6R8U1N249
  Content-Type: application/json
```

#### 响应处理
```go
// 成功响应
{
  "code": 200,
  "msg": "success"
}

// 限流响应（说明最近已绑定）
{
  "code": 429,
  "msg": "rate limited"
}
```

#### 自动重绑定逻辑
```go
// 每35秒检查是否需要重新绑定
if time.Since(lastIPBind) >= 35*time.Second {
    bindLocalIP()
}
```

### ⚠️ 注意事项

#### 1. **网络要求**
- 确保服务器能访问 `api.csqaq.com`
- 防火墙允许HTTPS出站连接

#### 2. **API Token**
- 确保使用正确的API Token
- Token必须有绑定IP的权限

#### 3. **IP限制**
- 绑定IP功能可能有地区限制
- 如果绑定失败，程序会自动降级到30秒模式

#### 4. **监控建议**
- 观察IP绑定状态日志
- 如果频繁绑定失败，检查网络和Token
- 监控429错误频率

### 🛠️ 故障排查

#### 问题1: IP绑定一直失败
**可能原因**: 
- API Token无效或无权限
- 网络连接问题
- IP地区限制

**解决方案**:
```bash
# 禁用IP绑定，使用安全模式
./bulk_fetch_goods_optimized-linux-amd64 -no-binding
```

#### 问题2: 请求仍然被限流
**可能原因**:
- IP绑定实际未成功
- API服务器负载高

**解决方案**:
- 检查日志中的IP绑定状态
- 适当增加请求间隔

#### 问题3: 程序运行很慢
**检查**:
- 确认IP绑定模式已启用
- 查看日志确认使用1秒间隔而非30秒

### 📈 性能优化建议

1. **使用IP绑定模式**: 速度提升30倍
2. **稳定网络环境**: 减少重试和超时
3. **监控资源使用**: 确保数据库和网络正常
4. **合理的批次大小**: 默认50个商品一批

这个新的实现确保了脚本能够正确利用CSQAQ API的IP绑定功能，大幅提升数据采集效率。
