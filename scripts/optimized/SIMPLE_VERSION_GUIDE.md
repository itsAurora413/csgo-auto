# 简化版脚本使用说明

## 🎯 简化逻辑

根据您的要求，重新设计了一个非常简单清晰的版本：

### 📋 工作流程

1. **启动时绑定IP**: 程序启动后立即绑定IP
2. **所有API调用前等待1秒**: 包括绑定IP和查询商品
3. **串行处理**: 一个接一个地查询商品信息
4. **定时重绑定**: 单独的定时器每30秒重新绑定IP

### 🔄 详细流程

```
启动程序
    ↓
绑定IP (等待1秒)
    ↓
启动30秒定时器 (后台运行)
    ↓
开始处理商品:
    等待1秒 → 查询good_id_0 → 等待1秒 → 查询good_id_1 → ...
    
后台定时器:
    每30秒 → 等待1秒 → 重新绑定IP → 继续等待30秒
```

### 🚀 使用方法

```bash
# 编译
cd scripts/optimized
go build -o bulk_fetch_goods_simple bulk_fetch_goods_simple.go

# 运行
./bulk_fetch_goods_simple
```

### 📊 预期性能

- **请求间隔**: 严格1秒
- **IP绑定**: 每30秒重新绑定
- **预估时间**: ~6.7小时 (24042商品 × 1秒 + 重试时间)

### 📝 日志示例

#### 启动日志
```
2024/10/11 12:00:00 开始获取饰品数据: ID 0 到 24041
2024/10/11 12:00:00 工作模式: 绑定IP -> 等待1秒 -> 查询商品 -> 重复
2024/10/11 12:00:00 IP重绑定: 每30秒自动重新绑定
2024/10/11 12:00:00 等待 999ms
2024/10/11 12:00:01 ✅ 成功绑定本地IP到CSQAQ API
```

#### 运行日志
```
2024/10/11 12:00:01 开始处理范围: 0 - 24041 (24042 个商品)
2024/10/11 12:00:01 等待 999ms
2024/10/11 12:00:02 ✓ 保存 good_id 12021 (AK-47 | Redline), 价格: YYYP=25.50, Buff=24.80
2024/10/11 12:00:02 等待 999ms
2024/10/11 12:00:03 跳过 good_id 12022, 价格超出范围: YYYP=500.00, Buff=480.00
```

#### 重绑定日志
```
2024/10/11 12:00:31 🔗 开始重新绑定IP...
2024/10/11 12:00:31 等待 999ms
2024/10/11 12:00:32 ✅ 成功绑定本地IP到CSQAQ API
```

### 🔧 核心特性

#### 1. **全局API控制器**
```go
type APIController struct {
    lastRequest time.Time
    mu          sync.Mutex
}

// 所有API调用都通过这个控制器
func (ac *APIController) waitInterval() {
    // 确保任何API调用间隔至少1秒
}
```

#### 2. **简单的绑定逻辑**
```go
// 绑定IP也要等待1秒
func (ac *APIClient) BindLocalIP(ctx context.Context) error {
    apiController.waitInterval()  // 等待1秒
    // 执行绑定...
}
```

#### 3. **独立的定时器**
```go
// 每30秒重新绑定，不影响主流程
func (p *Processor) StartIPBindingTimer(ctx context.Context) {
    ticker := time.NewTicker(30 * time.Second)
    // 定时绑定...
}
```

### ⚠️ 注意事项

1. **严格1秒间隔**: 所有API调用（包括绑定IP）都严格遵守1秒间隔
2. **简单可靠**: 没有复杂的状态管理，逻辑清晰
3. **自动重绑定**: 后台定时器自动处理IP重绑定
4. **错误处理**: 绑定失败不会影响主流程

### 🆚 与复杂版本对比

| 特性 | 复杂版本 | 简化版本 |
|------|----------|----------|
| IP绑定检查 | 复杂状态管理 | 简单定时器 |
| 间隔控制 | 多种间隔模式 | 统一1秒间隔 |
| 错误处理 | 多层级处理 | 简单日志记录 |
| 代码复杂度 | 高 | 低 |
| 维护难度 | 难 | 易 |

### 📁 文件对比

```
scripts/optimized/
├── bulk_fetch_goods_optimized.go    # 复杂版本（730行）
├── bulk_fetch_goods_simple.go       # 简化版本（约600行）
└── bulk_fetch_goods_simple          # 简化版本可执行文件
```

这个简化版本完全按照您的要求：**运行脚本 → 绑定IP → 等待1秒 → 查询good信息 → 等待1秒 → 查询下一个good信息**，同时后台定时器每30秒重新绑定IP，所有操作都严格遵守1秒间隔！
