# CSGO 预测服务 v2.0 工作流程

## 1. 系统架构流程图

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        Flask REST API Server                             │
│                          (Port 5000)                                     │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                    ┌───────────────┼───────────────┐
                    │               │               │
            ┌───────▼────────┐  ┌──▼──────────┐  ┌─▼──────────────┐
            │ API Endpoints  │  │ Model Cache │  │ Alert System   │
            ├────────────────┤  ├─────────────┤  ├────────────────┤
            │ /api/health    │  │ MODEL_CACHE │  │ DriftAlertSys  │
            │ /api/predict   │  │ (In-Memory) │  │ RetrainingTrig │
            │ /api/batch     │  │             │  │ AlertIntegr    │
            │ /api/metrics   │  │             │  │                │
            │ /api/alerts    │  │             │  │                │
            │ /api/data-qual │  └─────────────┘  └────────────────┘
            └───────┬────────┘
                    │
        ┌───────────┼───────────┬──────────────┬─────────────┐
        │           │           │              │             │
   ┌────▼───┐  ┌───▼────┐  ┌──▼─────┐  ┌────▼────┐  ┌─────▼──┐
   │ MySQL  │  │ Quality│  │ Drift  │  │ Cleaner │  │ Models │
   │Database│  │Checker │  │Detector│  │         │  │        │
   │        │  │        │  │        │  │         │  │        │
   │ Data   │  │ 7项    │  │ 5种    │  │- Remove │  │- LR    │
   │Fetch   │  │检查    │  │统计    │  │ Outlier │  │- Prophet│
   │        │  │        │  │方法    │  │- Fill   │  │- XGBoost│
   └────────┘  └────────┘  └────────┘  │ Missing │  └────────┘
                                         │- Remove │
                                         │ Duplicat│
                                         └─────────┘
```

## 2. 预测请求流程（核心工作流）

```
用户请求预测
     │
     ▼
┌─────────────────────────────────────────┐
│ GET /api/predict/<good_id>?days=7       │
│ 或 POST /api/batch-predict               │
└─────────────────────────────────────────┘
     │
     ▼
┌─────────────────────────────────────────┐
│ 1. 检查模型缓存                          │
├─────────────────────────────────────────┤
│ if good_id in MODEL_CACHE:               │
│   → 使用缓存的模型                       │
│ else:                                    │
│   → 加载或创建模型                       │
└─────────────────────────────────────────┘
     │
     ├─── YES (有缓存)
     │      │
     │      ▼
     │    使用现有模型
     │      │
     │      └──┬──────────────┐
     │         │              │
     │    ┌────▼────┐     ┌───▼─────┐
     │    │预测价格 │     │返回结果 │
     │    └─────────┘     └─────────┘
     │
     └─── NO (无缓存)
            │
            ▼
        ┌─────────────────────────────────┐
        │ 2. 从数据库获取历史数据          │
        ├─────────────────────────────────┤
        │ fetch_historical_data(good_id)  │
        │ - 获取最近30天数据              │
        │ - 至少需要10条记录              │
        └─────────────────────────────────┘
            │
            ▼
        ┌─────────────────────────────────┐
        │ 3. 创建模型对象                  │
        ├─────────────────────────────────┤
        │ model = PredictionModel(good_id) │
        │ model.load_model()  # 尝试加载  │
        └─────────────────────────────────┘
            │
            ├─── 模型存在
            │      │
            │      ▼
            │   ┌─────────────┐
            │   │ 加载模型    │
            │   │ 到内存      │
            │   └─────────────┘
            │      │
            │      └──────┐
            │             │
            └─── 模型不存在
                   │
                   ▼
            ┌──────────────────────────────┐
            │ 4. 数据质量检查               │
            ├──────────────────────────────┤
            │ QUALITY_CHECKER.check_quality│
            │ 检查项:                      │
            │ - 缺失值比例                │
            │ - 异常值个数                │
            │ - 统计特性 (mean, std, ...)│
            │ - 时间序列特性              │
            │ - 连续重复个数              │
            │ - 易变性                    │
            │ - 数据范围                  │
            │ 返回: quality_level         │
            │ (good/warning/critical)     │
            └──────────────────────────────┘
                   │
                   ▼
            ┌──────────────────────────────┐
            │ 5. 检查6小时内价格           │
            ├──────────────────────────────┤
            │ recent_6h = 最近6小时数据    │
            │ if 所有价格完全相同:         │
            │   → 长期无交易，返回 False   │
            │   → 不符合训练要求          │
            └──────────────────────────────┘
                   │
                   ├─── 价格有变化 ✓
                   │      │
                   │      ▼
                   │  ┌──────────┐
                   │  │继续训练  │
                   │  └──────────┘
                   │      │
                   └──────┴──────────┐
                          │          │
                          ▼          ▼
                  (quality级别)   (价格检查)

            ┌──────────────────────────────┐
            │ 6. 数据清理（如果质量严重）   │
            ├──────────────────────────────┤
            │ if quality_level == critical: │
            │   DATA_CLEANER.clean_data()  │
            │   - 移除异常值 (IQR方法)     │
            │   - 填补缺失值 (线性插值)    │
            │   - 移除连续重复 (>10个)    │
            │ 清理后数据 >= 10 才继续      │
            └──────────────────────────────┘
                   │
                   ▼
            ┌──────────────────────────────┐
            │ 7. 数据漂移检测               │
            ├──────────────────────────────┤
            │ DRIFT_DETECTOR.detect_drift()│
            │ 方法 (5种):                  │
            │ 1) KS检验 (分布差异)        │
            │ 2) KL散度 (信息论)          │
            │ 3) Wasserstein距离          │
            │ 4) 均值/方差变化            │
            │ 5) 价格范围变化             │
            │ 返回: drift_level           │
            │ (none/mild/moderate/severe) │
            └──────────────────────────────┘
                   │
                   ▼
            ┌──────────────────────────────┐
            │ 8. 生成告警                  │
            ├──────────────────────────────┤
            │ ALERT_SYSTEM.check_alerts()  │
            │ 规则 (7条):                  │
            │ 1) 数据质量严重 < 40分      │
            │ 2) 异常值过多 > 15%        │
            │ 3) 严重漂移                │
            │ 4) 中等漂移                │
            │ 5) 波动率过高 > 8%        │
            │ 6) 模型准确度差 MAPE>25%  │
            │ 7) 连续相同价格 > 10个    │
            └──────────────────────────────┘
                   │
                   ▼
            ┌──────────────────────────────┐
            │ 9. 检查是否需要重训练        │
            ├──────────────────────────────┤
            │ RETRAINING_TRIGGER           │
            │ .should_retrain(alerts)      │
            │                              │
            │ 触发条件:                    │
            │ - severe_drift               │
            │ - data_quality_critical      │
            │ - model_performance_drop(关键)
            │                              │
            │ 如果需要:                    │
            │ → 删除旧模型文件             │
            │ → 返回 False                 │
            │ → 下次请求强制重训           │
            └──────────────────────────────┘
                   │
                   ├─── 需要重训 → 返回False
                   │
                   └─── 不需要重训 ✓
                        │
                        ▼
            ┌──────────────────────────────┐
            │ 10. 数据准备                 │
            ├──────────────────────────────┤
            │ 分割: 70% 训练, 30% 测试    │
            │ 准备特征:                    │
            │ - day_of_week               │
            │ - day_of_month              │
            │ - days_since_start          │
            │ - price_range               │
            │ - total_orders              │
            │ - order_ratio               │
            │ - 移动平均 (MA3)            │
            │ - 价格变化率                │
            └──────────────────────────────┘
                   │
                   ▼
            ┌──────────────────────────────┐
            │ 11. 模型训练 (3个模型)       │
            ├──────────────────────────────┤
            │                              │
            │ A) 线性回归 (LR)            │
            │    - 输入: 时间索引          │
            │    - 输出: 价格趋势          │
            │                              │
            │ B) Prophet (Facebook)       │
            │    - 时间序列模型            │
            │    - 周期性 + 趋势           │
            │    - 置信区间                │
            │                              │
            │ C) XGBoost                  │
            │    - 梯度提升树              │
            │    - 使用工程特征            │
            │    - 非线性关系              │
            │                              │
            │ 计算指标:                    │
            │ - MSE (均方误差)            │
            │ - MAE (平均绝对误差)        │
            │ - MAPE (百分比误差)         │
            └──────────────────────────────┘
                   │
                   ▼
            ┌──────────────────────────────┐
            │ 12. 模型持久化               │
            ├──────────────────────────────┤
            │ model.save_model()          │
            │ - pickle保存 3个模型         │
            │ - 保存最后价格/时间戳        │
            │ - 保存训练统计              │
            │                              │
            │ model.save_metrics()        │
            │ - 保存质量指标到JSON        │
            │ - 质量报告                  │
            │ - 漂移报告                  │
            └──────────────────────────────┘
                   │
                   ▼
            ┌──────────────────────────────┐
            │ 13. 添加到缓存               │
            ├──────────────────────────────┤
            │ MODEL_CACHE[good_id] = model │
            └──────────────────────────────┘
                   │
                   ▼
        ┌─────────────────────────────────┐
        │ 14. 执行预测                    │
        ├─────────────────────────────────┤
        │ model.predict(days=7)           │
        │ - 生成未来7天日期 (freq='D')   │
        │ - 3个模型分别预测              │
        │ - 加权集成: 0.2*LR + 0.3*Prophet + 0.5*XGBoost
        │ - 返回日期 + 预测值 + 置信区间 │
        └─────────────────────────────────┘
             │
             ▼
        ┌─────────────────────────────────┐
        │ 15. 生成推荐                    │
        ├─────────────────────────────────┤
        │ 基于未来7天的平均价格:          │
        │ - 上升 > 5% → 'sell'           │
        │ - 下降 > 5% → 'buy'            │
        │ - 其他 → 'hold'                │
        └─────────────────────────────────┘
             │
             ▼
        ┌─────────────────────────────────┐
        │ 16. 返回结果                    │
        ├─────────────────────────────────┤
        │ {                               │
        │   'current_price': float,       │
        │   'forecast_days': 7,           │
        │   'predictions': {              │
        │     'lr': [...],                │
        │     'prophet': [...],           │
        │     'xgb': [...]                │
        │   },                            │
        │   'ensemble': {                 │
        │     'forecast': [...],          │
        │     'dates': [...],             │
        │   },                            │
        │   'recommendation': {           │
        │     'action': 'buy/hold/sell',  │
        │     'reason': '...'             │
        │   },                            │
        │   'quality_metrics': {...}      │
        │ }                               │
        └─────────────────────────────────┘
             │
             ▼
        ┌─────────────────────────────────┐
        │ 返回给客户端 (JSON)             │
        └─────────────────────────────────┘
```

## 3. 时序图：完整请求-响应周期

```
Client                API              Cache          Database       Model         Alert
  │                   │                 │               │            │              │
  │  GET /predict/123 │                 │               │            │              │
  ├──────────────────>│                 │               │            │              │
  │                   │ Check Cache     │               │            │              │
  │                   ├────────────────>│               │            │              │
  │                   │<────────────────┤ (not found)   │            │              │
  │                   │                 │               │            │              │
  │                   │ Fetch Data      │               │            │              │
  │                   ├───────────────────────────────>│            │              │
  │                   │<───────────────────────────────┤            │              │
  │                   │ Create Model    │               │            │              │
  │                   │────────────────────────────────────────────>│              │
  │                   │                 │               │            │ Check        │
  │                   │                 │               │            │ Quality      │
  │                   │                 │               │            ├─────────────>│
  │                   │                 │               │            │<─────────────┤
  │                   │                 │               │            │              │
  │                   │                 │               │            │ Check        │
  │                   │                 │               │            │ 6h Price     │
  │                   │ ◄─ OK ───────────────────────────────────────┤              │
  │                   │                 │               │            │              │
  │                   │                 │               │            │ Detect       │
  │                   │                 │               │            │ Drift        │
  │                   │                 │               │            ├─────────────>│
  │                   │                 │               │            │<─────────────┤
  │                   │                 │               │            │              │
  │                   │                 │               │            │ Check        │
  │                   │                 │               │            │ Alerts       │
  │                   │                 │               │            ├─────────────>│
  │                   │                 │               │            │<─────────────┤
  │                   │                 │               │            │              │
  │                   │                 │               │            │ Train        │
  │                   │                 │               │            │ Models       │
  │                   │                 │               │            │ (LR/Prophet/ │
  │                   │                 │               │            │  XGBoost)    │
  │                   │<────────────────────────────────────────────┤              │
  │                   │ Save Model      │               │            │              │
  │                   ├────────────────>│ (pickle+json)  │            │              │
  │                   │<────────────────┤               │            │              │
  │                   │                 │               │            │              │
  │                   │ Predict         │               │            │              │
  │                   ├────────────────────────────────────────────>│              │
  │                   │ (7 days, daily) │               │            │              │
  │                   │<────────────────────────────────────────────┤              │
  │                   │ Generate Result │               │            │              │
  │                   │ (LR+Prophet+XGB)│               │            │              │
  │                   │                 │               │            │              │
  │  JSON Result      │                 │               │            │              │
  │<──────────────────┤                 │               │            │              │
  │ (24h later)       │                 │               │            │              │
  │  GET /predict/123 │                 │               │            │              │
  ├──────────────────>│                 │               │            │              │
  │                   │ Check Cache     │               │            │              │
  │                   ├────────────────>│               │            │              │
  │                   │<────────────────┤ (found!)      │            │              │
  │                   │                 │               │            │              │
  │  JSON Result      │                 │               │            │              │
  │<──────────────────┤ (from cache, fast!)            │            │              │
  │                   │                 │               │            │              │
```

## 4. 数据清理流程

```
原始数据 (891条)
      │
      ▼
┌─────────────────────────┐
│ 1. 移除异常值 (IQR方法)  │
│    Q1, Q3, IQR           │
│    lower = Q1 - 1.5*IQR  │
│    upper = Q3 + 1.5*IQR  │
│    → 移除 65 条          │
└─────────────────────────┘
  (891 - 65 = 826)
      │
      ▼
┌─────────────────────────┐
│ 2. 填补缺失值            │
│    线性插值              │
│    → 填补 0 条          │
└─────────────────────────┘
  (826 - 0 = 826)
      │
      ▼
┌─────────────────────────┐
│ 3. 移除连续重复          │
│    (max_consecutive=10)  │
│    → 移除 678 条        │
└─────────────────────────┘
  (826 - 678 = 148)
      │
      ▼
最终数据 (148条) ✓

说明: 这个例子说明长期无交易
过去6小时价格完全相同 → 返回 False
```

## 5. 告警规则决策树

```
入力: quality_report + drift_report + performance_metrics
      │
      ▼
┌─────────────────────────────────────────────────┐
│ 规则1: 数据质量严重 (score < 40)                │
├─────────────────────────────────────────────────┤
│ 级别: CRITICAL                                  │
│ 建议: 立即数据清理，检查数据源                  │
└─────────────────────────────────────────────────┘
      │
      ▼
┌─────────────────────────────────────────────────┐
│ 规则2: 异常值过多 (ratio > 15%)                │
├─────────────────────────────────────────────────┤
│ 级别: WARNING                                   │
│ 建议: 检查市场事件，考虑异常值移除              │
└─────────────────────────────────────────────────┘
      │
      ▼
┌─────────────────────────────────────────────────┐
│ 规则3: 严重漂移 (drift_level == 'severe')      │
├─────────────────────────────────────────────────┤
│ 级别: CRITICAL                                  │
│ 建议: 删除旧模型，强制重训                      │
│ 触发: 自动重训                                  │
└─────────────────────────────────────────────────┘
      │
      ▼
┌─────────────────────────────────────────────────┐
│ 规则4: 中等漂移 (drift_level == 'moderate')    │
├─────────────────────────────────────────────────┤
│ 级别: WARNING                                   │
│ 建议: 监控模型，必要时重训                      │
└─────────────────────────────────────────────────┘
      │
      ▼
┌─────────────────────────────────────────────────┐
│ 规则5: 波动率高 (volatility > 8%)              │
├─────────────────────────────────────────────────┤
│ 级别: WARNING                                   │
│ 建议: 检查赛事/版本更新                         │
└─────────────────────────────────────────────────┘
      │
      ▼
┌─────────────────────────────────────────────────┐
│ 规则6: 模型准度差 (MAPE > 25%)                 │
├─────────────────────────────────────────────────┤
│ 级别: WARNING                                   │
│ 建议: 清空缓存，强制重训                        │
│ 触发: 自动重训                                  │
└─────────────────────────────────────────────────┘
      │
      ▼
┌─────────────────────────────────────────────────┐
│ 规则7: 连续相同价格 (count > 10)               │
├─────────────────────────────────────────────────┤
│ 级别: WARNING                                   │
│ 建议: 检查数据源通讯问题                        │
└─────────────────────────────────────────────────┘
      │
      ▼
┌─────────────────────────────────────────────────┐
│ 是否触发重训练?                                  │
├─────────────────────────────────────────────────┤
│ 条件:                                           │
│ ✓ 严重漂移 (severe_drift)                      │
│ ✓ 数据质量严重 (data_quality_critical)         │
│ ✓ 模型准度极差 (model_performance_drop+CRITICAL)
│                                                 │
│ 如果满足:                                      │
│ → 删除旧模型文件                                │
│ → 下次请求强制重训                              │
│ → 返回 False (本次训练中止)                     │
└─────────────────────────────────────────────────┘
```

## 6. 模型集成预测流程

```
7天未来日期 (2025-11-20 ~ 2025-11-26)
  │
  ├─── 线性回归 (LR)
  │      │
  │      ├─ 输入: 时间索引 [train_size, train_size+7)
  │      ├─ 训练: 历史趋势拟合
  │      └─ 输出: [p1_lr, p2_lr, ..., p7_lr]
  │
  ├─── Prophet
  │      │
  │      ├─ 输入: 日期范围 (freq='D')
  │      ├─ 训练: 周期性 + 趋势分解
  │      └─ 输出: [p1_ph, p2_ph, ..., p7_ph]
  │              (包含置信区间)
  │
  └─── XGBoost
         │
         ├─ 输入: 工程特征 (day_of_week, 移动平均等)
         ├─ 训练: 非线性关系
         └─ 输出: [p1_xgb, p2_xgb, ..., p7_xgb]

集成预测 (加权平均)
      │
      ├─ LR权重: 0.2
      ├─ Prophet权重: 0.3
      └─ XGBoost权重: 0.5
         │
         ▼
    P[i] = 0.2*p[i]_lr + 0.3*p[i]_ph + 0.5*p[i]_xgb

输出 (每天一条)
    [
      {date: '2025-11-20', price: 123.45},
      {date: '2025-11-21', price: 125.67},
      ...
      {date: '2025-11-26', price: 128.90}
    ]

计算平均价格 (用于推荐)
    avg_price = mean([123.45, 125.67, ..., 128.90])
              = 126.78

判断趋势
    current_price = 120.00
    change_pct = (126.78 - 120) / 120 * 100 = 5.65%

    if change_pct > 5%:  ✓
      recommendation = 'sell'
      reason = '未来7天平均价格预测上升 5.7%'
```

## 7. 核心数据流

```
原始数据 (30天历史)
  ↓
数据质量检查 (7项检查)
  ↓
条件检查:
  ├─ 数据不足 (< 10) ? → 返回 False
  ├─ 6小时价格完全相同 ? → 返回 False
  └─ 质量严重 ? → 清理 → 检查数据足够 ?
                         → 不足 ? → 返回 False
  ↓
70% 训练 + 30% 测试 分割
  ↓
特征工程 (9个特征)
  ↓
├─ 线性回归: 时间序列趋势
├─ Prophet: 周期性分解
└─ XGBoost: 非线性模型
  ↓
计算质量指标 (MSE, MAE, MAPE)
  ↓
保存模型 + 指标
  ↓
内存缓存
  ↓
预测请求
  ↓
生成7天日期 (freq='D')
  ↓
3个模型预测
  ↓
加权集成 (LR:0.2 + Prophet:0.3 + XGBoost:0.5)
  ↓
生成推荐 (buy/hold/sell)
  ↓
返回 JSON (带日期)
```

## 8. 系统状态转换

```
                    ┌─────────────────┐
                    │  初始状态       │
                    │  (无模型)       │
                    └────────┬────────┘
                             │
                      请求预测
                             │
                    ┌────────▼────────┐
                    │  加载或训练      │
                    │  新模型          │
                    └────────┬────────┘
                             │
                    ┌────────▼────────┐
                    │  模型存在       │
                    │  缓存中         │
                    └────────┬────────┘
                             │
                    后续请求  │
                             │
                    ┌────────▼────────┐
      ┌────────────┤ 模型缓存有效?   ├────────────┐
      │            └─────────────────┘            │
      │ YES                              NO       │
      │                                           │
   ┌──▼───────┐                          ┌───────▼──┐
   │快速返回  │                          │检测漂移  │
   │(缓存)    │                          │/质量     │
   └──┬───────┘                          └───┬──────┘
      │                                      │
      │                            ┌─────────▼─────────┐
      │                            │ 需要重训练?      │
      │                            └────┬──────┬──────┘
      │                                 │      │
      │                            YES  │      │ NO
      │                                 │      │
      │                          ┌──────▼──┐ ┌─▼────────┐
      │                          │删除旧   │ │继续使用  │
      │                          │模型     │ │缓存模型  │
      │                          └──────┬──┘ └─┬────────┘
      │                                 │      │
      │                          ┌──────▼──────▼───┐
      │                          │下次请求强制    │
      │                          │重训            │
      │                          └────────────────┘
      │                                 │
      │                          请求预测(重新训练)
      │                                 │
      │                          ┌──────▼────────┐
      └─────────────────────────>│预测结果       │
                                 └───────────────┘
```

## 9. 文件结构和依赖

```
prediction_service_v2.py (主服务)
  ├─ 导入: data_quality_monitor.py
  │        ├─ DataQualityChecker
  │        ├─ DataDriftDetector
  │        ├─ DataCleaner
  │        └─ DataQualityReport, DataDriftReport (dataclass)
  │
  ├─ 导入: drift_alert_system.py
  │        ├─ DriftAlertSystem
  │        ├─ RetrainingTrigger
  │        └─ Alert (dataclass)
  │
  ├─ 类: PredictionModel
  │        ├─ LinearRegression (sklearn)
  │        ├─ Prophet (facebook)
  │        └─ XGBRegressor (xgboost)
  │
  ├─ API路由
  │   ├─ /api/health
  │   ├─ /api/predict/<good_id>
  │   ├─ /api/batch-predict
  │   ├─ /api/model-metrics/<good_id>
  │   ├─ /api/alerts/<good_id>
  │   ├─ /api/alerts/active
  │   ├─ /api/alerts/summary
  │   ├─ /api/data-quality/<good_id>
  │   ├─ /api/clear-cache
  │   └─ /api/cache-status
  │
  └─ 存储
       ├─ /root/csgo-prediction/.cache/models/ (pickle)
       ├─ /root/csgo-prediction/.cache/metrics/ (JSON)
       └─ /root/csgo-prediction/.cache/alerts/ (JSON)
```

## 10. 关键参数配置表

| 参数 | 值 | 说明 |
|------|-----|------|
| 历史数据天数 | 30 | fetch_historical_data 参数 |
| 最少数据点 | 10 | 训练最少要求 |
| 6小时检查 | 6 | 检查是否长期无交易 |
| 连续重复阈值 | 10 | max_consecutive 参数 |
| 训练-测试分割 | 70:30 | 数据分割比例 |
| LR权重 | 0.2 | 线性回归在集成中的权重 |
| Prophet权重 | 0.3 | Prophet在集成中的权重 |
| XGBoost权重 | 0.5 | XGBoost在集成中的权重 |
| 质量严重阈值 | < 40 | quality_score 告警阈值 |
| 异常值阈值 | > 15% | outlier_ratio 告警阈值 |
| 波动率阈值 | > 8% | volatility 告警阈值 |
| 模型准度阈值 | > 25% | MAPE 告警阈值 |
| 预测周期 | 7天 | 默认预测天数 |
| 预测频率 | 日 (D) | 以天为单位预测 |
| 数据采集频率 | 20-30分钟 | 实际数据更新周期 |
| API端口 | 5000 | Flask服务端口 |

这就是整个 prediction_service_v2.py 的完整工作流程！
